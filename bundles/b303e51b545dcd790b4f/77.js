"use strict";(self.webpackChunkelement_web=self.webpackChunkelement_web||[]).push([[77],{"./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/SendWysiwygComposer.tsx":(e,t,n)=>{n.r(t),n.d(t,{default:()=>F});var o=n("./node_modules/@babel/runtime/helpers/esm/extends.js"),s=n("./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),r=n("./node_modules/react/index.js"),i=n("./node_modules/matrix-react-sdk/src/dispatcher/dispatcher.ts"),c=n("./node_modules/matrix-react-sdk/src/dispatcher/actions.ts"),a=n("./node_modules/matrix-react-sdk/src/contexts/RoomContext.ts"),l=n("./node_modules/matrix-react-sdk/src/hooks/useDispatcher.ts"),d=n("./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/hooks/utils.ts"),u=n("./node_modules/matrix-react-sdk/src/dispatcher/payloads/ComposerInsertPayload.ts"),m=n("./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/ComposerContext.ts"),f=n("./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/utils/selection.ts");var p=n("./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/components/WysiwygComposer.tsx"),g=n("./node_modules/classnames/index.js"),h=n.n(g);var x=n("./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/hooks/useIsFocused.ts");var v=n("./node_modules/matrix-react-sdk/src/hooks/useSettings.ts"),C=n("./node_modules/matrix-react-sdk/src/Keyboard.ts"),y=n("./node_modules/matrix-js-sdk/src/logger.ts"),k=n("./node_modules/matrix-react-sdk/src/Typeguards.ts");function w(e,t){var n;const[o,s]=(0,r.useState)(null),i=e=>{y.k.log(`## 26037 ## wysiwyg useSuggestion hook setting suggestion data to ${null===e||e instanceof Function?e:e.mappedSuggestion.keyChar+e.mappedSuggestion.text}`),s(e)};return{suggestion:null!==(n=null==o?void 0:o.mappedSuggestion)&&void 0!==n?n:null,handleCommand:e=>function(e,t,n,o){var s;if(null===t)return;const{node:r}=t,i=`${e} `;r.textContent=i,null===(s=document.getSelection())||void 0===s||s.setBaseAndExtent(r,i.length,r,i.length),o(i),n(null)}(e,o,i,t),handleMention:(e,n,s)=>_(e,n,s,o,i,t),handleAtRoomMention:e=>_("#","@room",e,o,i,t),onSelect:()=>function(e,t){var n;const o=document.getSelection();if(null===e.current||null===o||!o.isCollapsed||"#text"!==(null===(n=o.anchorNode)||void 0===n?void 0:n.nodeName))return void t(null);const{anchorNode:s,anchorOffset:r}=o;if(null===s.textContent)return void t(null);const i=document.createNodeIterator(e.current,NodeFilter.SHOW_TEXT).nextNode(),c=s===i,a=function(e,t,n){if(t<0||t>e.length)return null;let o=t,s=t;for(;b(e,o);)o--;for(;S(e,s);)s++;const r=e.slice(o,s),i=function(e){const t=e.charAt(0),n=e.slice(1);switch(t){case"/":return{keyChar:t,text:n,type:"command"};case"#":case"@":return{keyChar:t,text:n,type:"mention"};default:return null}}(r);if(null===i||"command"===i.type&&(!n||0!==o||s!==e.length))return null;return{mappedSuggestion:i,startOffset:o,endOffset:o+r.length}}(s.textContent,r,c);if(null===a)return void t(null);t({mappedSuggestion:a.mappedSuggestion,node:s,startOffset:a.startOffset,endOffset:a.endOffset})}(e,i)}}function _(e,t,n,o,s,r){var i,c,a,l;if(null===o)return;const{node:d}=o,u=document.createElement("a"),m=document.createTextNode(t);u.setAttribute("href",e),u.setAttribute("contenteditable","false");for(const[e,t]of n.entries())u.setAttribute(e,t);u.appendChild(m);const f=document.createTextNode((null===(i=d.textContent)||void 0===i?void 0:i.slice(0,o.startOffset))||"â€‹"),p=document.createTextNode(` ${null!==(c=null===(a=d.textContent)||void 0===a?void 0:a.slice(o.endOffset))&&void 0!==c?c:""}`),g=d.parentNode;(0,k.K)(g)&&(g.insertBefore(f,d),g.insertBefore(u,d),g.insertBefore(p,d),g.removeChild(d)),null===(l=document.getSelection())||void 0===l||l.setBaseAndExtent(p,1,p,1),r(),s(null)}function b(e,t){return!(t<=0)&&!/\s/.test(e[t-1])}function S(e,t){return!(t>=e.length)&&!/\s/.test(e[t])}var T=n("./node_modules/matrix-react-sdk/src/contexts/MatrixClientContext.tsx");function E(e,t,n,o){const s=(0,a.fZ)(),i=(0,T.wb)(),c=(0,r.useRef)(null),l=(0,r.useRef)(null),[u,m]=(0,r.useState)(e),f=(0,r.useCallback)((()=>{c.current&&(c.current.innerHTML=""),null==n||n()}),[c,n]),p=(0,r.useCallback)((e=>{if((0,k.p)(e))m(e),null==t||t(e);else if((0,k.K)(c)&&(0,k.K)(c.current)){const e=c.current.innerHTML;m(e),null==t||t(e)}}),[t,c]),{suggestion:g,onSelect:h,handleCommand:x,handleMention:y,handleAtRoomMention:_}=w(c,p),b=(0,r.useCallback)((e=>{e.target instanceof HTMLDivElement&&p(e.target.innerHTML)}),[p]),S=(0,r.useCallback)((e=>{const{nativeEvent:t}=e;let n=!1;if((0,d.EM)(t)){const e=t instanceof ClipboardEvent?t.clipboardData:t.dataTransfer;n=(0,d.cT)(t,e,s,i,o)}n?e.preventDefault():b(e)}),[o,i,b,s]),E=!(0,v.t)("MessageComposerInput.ctrlEnterToSend"),M=(0,r.useCallback)((e=>{if(!(0,d.z8)(l,e)&&e.key===C.sr.ENTER){const t=C.Mq?e.metaKey:e.ctrlKey;E&&!e.shiftKey&&(e.preventDefault(),e.stopPropagation(),f()),!E&&t&&(e.preventDefault(),e.stopPropagation(),f())}}),[l,E,f]);return{ref:c,autocompleteRef:l,onBeforeInput:S,onInput:b,onPaste:S,onKeyDown:M,content:u,setContent:p,suggestion:g,onSelect:h,handleCommand:x,handleMention:y,handleAtRoomMention:_}}var M=n("./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/hooks/useSetCursorPosition.ts"),R=n("./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/components/Editor.tsx"),P=n("./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/components/WysiwygAutocomplete.tsx");function N({className:e,disabled:t=!1,onSend:n,onChange:o,children:s,placeholder:i,initialContent:c,leftComponent:a,rightComponent:l,eventRelation:d}){const{ref:u,autocompleteRef:m,onBeforeInput:p,onInput:g,onPaste:v,onKeyDown:C,content:y,setContent:k,suggestion:w,onSelect:_,handleCommand:b,handleMention:S,handleAtRoomMention:T}=E(c,o,n,d),N=function(e,t){return(0,r.useMemo)((()=>({clear:()=>{e.current&&(e.current.innerHTML="")},insertText:n=>{const o=document.getSelection();if(e.current&&o){const s=e.current.innerHTML,{anchorOffset:r,focusOffset:i}=o;e.current.innerHTML=`${s.slice(0,r)}${n}${s.slice(i)}`,(0,f.Z5)({anchorNode:e.current.firstChild,anchorOffset:r+n.length,focusNode:e.current.firstChild,focusOffset:i+n.length,isForward:!0}),t(e.current.innerHTML)}}})),[e,t])}(u,k);!function(e="",t){(0,r.useEffect)((()=>{t.current&&(t.current.innerHTML=e)}),[t,e])}(c,u),(0,M.B)(t,u);const{isFocused:A,onFocus:I}=(0,x.r)(),O=!y&&i||void 0;return r.createElement("div",{"data-testid":"PlainTextComposer",className:h()(e,{[`${e}-focused`]:A}),onFocus:I,onBlur:I,onBeforeInput:p,onInput:g,onPaste:v,onKeyDown:C,onSelect:_},r.createElement(P.p,{ref:m,suggestion:w,handleMention:S,handleCommand:b,handleAtRoomMention:T}),r.createElement(R.M,{ref:u,disabled:t,leftComponent:a,rightComponent:l,placeholder:O}),null==s?void 0:s(u,N))}var A=n("./node_modules/matrix-react-sdk/src/components/views/rooms/E2EIcon.tsx"),I=n("./node_modules/matrix-react-sdk/src/components/views/rooms/EmojiButton.tsx");function O({menuPosition:e}){const t=(0,a.fZ)();return r.createElement(I.K,{menuPosition:e,addEmoji:e=>(i.ZP.dispatch({action:c.a.ComposerInsert,text:e,timelineRenderingType:t.timelineRenderingType}),!0)})}const K=["isRichTextEnabled","e2eStatus","menuPosition"],B=(0,r.forwardRef)((function({disabled:e=!1,composerFunctions:t},n){return function(e,t,n){const o=(0,a.fZ)(),s=(0,m.ar)(),p=(0,r.useRef)(null),g=(0,r.useCallback)((r=>{var i;if(e||null==t||!t.current)return;const l=null!==(i=r.context)&&void 0!==i?i:a.SB.Room;switch(r.action){case"reply_to_event":case c.a.FocusAComposer:case c.a.FocusSendMessageComposer:(0,d.Kq)(t,l,o,p);break;case c.a.ClearAndFocusSendMessageComposer:if(r.timelineRenderingType!==o.timelineRenderingType)break;n.clear(),(0,d.Kq)(t,l,o,p);break;case c.a.ComposerInsert:if(r.timelineRenderingType!==o.timelineRenderingType)break;if(r.composerType!==u.P.Send)break;r.userId||r.event||r.text&&(0,f.Z5)(s.selection).then((()=>n.insertText(r.text)))}}),[e,t,o,n,s]);(0,l.P)(i.ZP,g)}(e,n,t),null}));function F(e){let{isRichTextEnabled:t,e2eStatus:n,menuPosition:i}=e,c=(0,s.Z)(e,K);const a=t?p.O:N,l=(0,r.useRef)((0,m.Q3)({eventRelation:c.eventRelation}));return r.createElement(m.IA.Provider,{value:l.current},r.createElement(a,(0,o.Z)({className:"mx_SendWysiwygComposer",leftComponent:n&&r.createElement(A.Z,{status:n}),rightComponent:r.createElement(O,{menuPosition:i})},c),((e,t)=>r.createElement(B,{disabled:c.disabled,ref:e,composerFunctions:t}))))}}}]);
//# sourceMappingURL=77.js.map